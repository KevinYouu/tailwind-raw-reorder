# 正则表达式问题分析与修复方案

## 问题描述

当前 `package.json` 中 `javascriptreact`/`typescript`/`typescriptreact` 的正则表达式存在问题，无法正确处理嵌套的模板字符串。

### 问题案例

```jsx
className={`whitespace-pre-wrap text-sm text-gray-600 ${
  !isExpanded ? `line-clamp-${maxLines}` : ''
}`}
```

会被错误地格式化为：

```jsx
className={`whitespace-pre-wrap text-sm text-gray-600 ${
  !isExpanded ? }`line-clamp-${maxLines}` : ''
}`}
```

## 根本原因

当前的正则表达式：

```javascript
"`([^`]*(?:\\$\\{[^}]*\\}[^`]*)*)`"
```

问题在于 `[^`]*` 这个模式：
- 它表示"匹配任何不是反引号的字符"
- 当遇到嵌套模板字符串（如 `` `line-clamp-${maxLines}` ``）时
- 外层正则在遇到内层的第一个反引号时就停止匹配
- 导致只捕获了部分内容：`` `whitespace-pre-wrap ... ? ` ``
- 而不是完整内容

## 解决方案

### 方案 1：改进正则表达式（推荐但复杂）

使用更复杂的正则来处理嵌套的反引号：

```javascript
"`((?:[^`$]|\\$(?!\\{)|\\$\\{(?:[^}]|\\{[^}]*\\})*\\})*)`"
```

这个正则的逻辑：
- `[^`$]` - 匹配不是反引号或 $ 的字符
- `\\$(?!\\{)` - 匹配不后跟 { 的 $
- `\\$\\{(?:[^}]|\\{[^}]*\\})*\\}` - 匹配 ${...} 表达式，包括内部可能的嵌套大括号

**问题：** 这个方案仍然无法完美处理所有嵌套情况，因为正则表达式本身不适合处理递归嵌套结构。

### 方案 2：使用专门的解析器（最佳方案）

不依赖正则表达式来精确捕获嵌套模板字符串，而是：

1. 使用第一层正则粗略匹配 `className={...}` 或 `className="..."`
2. 在代码中使用专门的解析器来提取完整的模板字符串内容
3. 这样可以正确处理任意嵌套级别

### 方案 3：简化正则（实用方案）

修改策略，使用更宽松的匹配模式：

```javascript
// 第一层：匹配整个 className={...} 块
"(?:class(?:Name)?|tw)\\s*=\\s*\\{([^}]+(?:\\{[^}]*\\}[^}]*)*)\\}"

// 第二层：提取内容（在代码中处理，不用正则）
```

但这需要修改 `src/utils.ts` 中的处理逻辑。

## 当前代码已有的保护

好消息是，`src/complex-expressions.ts` 中的 `sortTemplateClasses` 函数已经有很好的解析逻辑来处理嵌套结构：

```typescript
// 它使用字符级解析来正确跟踪大括号和字符串边界
while (exprEnd < templateString.length) {
  const char = templateString[exprEnd];
  
  // 处理字符串边界
  if ((char === '"' || char === "'" || char === '`') && ...) {
    // 正确跟踪字符串
  }
  
  // 只在字符串外计数大括号
  if (!inString) {
    if (char === '{') braceDepth++;
    else if (char === '}') { ... }
  }
}
```

**问题是：** 如果正则表达式在第一步就没有正确捕获完整内容，这个解析器就无法发挥作用。

## 推荐修复

修改 `package.json` 中的正则表达式，采用更宽松的匹配策略：

```json
"javascriptreact": [
  [
    "(?:class(?:Name)?|tw)\\s*=\\s*\\{\\s*(`[^`]*`|([\"'])(?:(?:\\\\.|(?!\\2).)*?)\\2)",
    "`([^`]*)`|[\"']([^\"']+)[\"']"
  ]
],
```

但更好的方式是改进匹配逻辑，让它能够捕获整个表达式，然后在代码中解析。

## 临时解决方案

如果用户遇到此问题，可以：

1. 避免使用嵌套的模板字符串
2. 改用字符串拼接或其他方式
3. 手动调整格式化后的代码

## 建议

需要重新设计正则表达式匹配策略，或者改进 `src/utils.ts` 中的 `getTextMatch` 函数，使其能够：

1. 更智能地识别 JavaScript/JSX 表达式边界
2. 使用 AST 解析而不是正则表达式（可能需要引入轻量级解析库）
3. 或者提供配置选项让用户自定义更适合其代码风格的正则
